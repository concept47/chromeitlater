<!-- 
	Copyright 2010 Kenneth Liu.
 
	This file is part of ChromeItLater.

    ChromeItLater is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 2 of the License, or
    any later version.

    ChromeItLater is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with ChromeItLater.  If not, see <http://www.gnu.org/licenses/>.
-->
<html>
<head>
	<script src="lib/prototype.js" type="text/javascript"></script>
	<script src="readitlater-client.js"></script> 
	<script>                                  
	
	var api;

		//TODO this is currently never invoked because of the popup
		//the Extensions API will provide a workaround for this	
	function addTab() {
		chrome.tabs.getSelected(null, 
			function(tab) { 
				console.debug(tab);
				add(localStorage.username, localStorage.password, tab.url, tab.title);
				chrome.tabs.remove(tab.id, function(){
					console.debug("closed tab" + tab.url);
				}); 
		});
	}
	
	function createContextMenu() {
		chrome.contextMenus.create({
			"title": "Add to Read It Later",
			"contexts": ["page", "link"],
			"onclick": addFromContextMenu
		})
	}
	
	function addFromContextMenu(info, tab) {
		if (info.linkUrl) { 
			alert ('clicked URL: ' + info.linkUrl);       
			//TODO figure out how to fetch title instead of just URL
			//TODO check or http or https and error appropriately
			add(localStorage.username, localStorage.password, info.linkUrl, info.linkUrl);  
		}
		else { //right clicked on page
			alert('clicked on page: ' + info.pageUrl);
			add(localStorage.username, localStorage.password, info.pageUrl, tab.title); 
		}                                                                               
		//TDODO deal with frames
	}

	function init(){
		chrome.browserAction.onClicked.addListener(addTab);
		api = new ReadItLaterAPI();
		createContextMenu();
	}

	</script>               
</head>

<body onload="init()">
</body>
</html>