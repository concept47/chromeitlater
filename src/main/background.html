<!-- 
	Copyright 2010 Kenneth Liu.
 
	This file is part of ChromeItLater.

    ChromeItLater is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 2 of the License, or
    any later version.

    ChromeItLater is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with ChromeItLater.  If not, see <http://www.gnu.org/licenses/>.
-->
<html>
<head>
	<script src="lib/prototype.js" type="text/javascript"></script>
	<script src="readitlater-client.js"></script> 
	<script>                                  
	
	var api;

		//TODO this is currently never invoked because of the popup
		//the Extensions API will provide a workaround for this	
	function addTab() {
		chrome.tabs.getSelected(null, 
			function(tab) { 
				console.debug(tab);
				add(localStorage.username, localStorage.password, tab.url, tab.title);
				chrome.tabs.remove(tab.id, function(){
					console.debug("closed tab" + tab.url);
				}); 
		});
	}
	
	function addWithBadgeIndicator(url, title) {
		chrome.browserAction.setBadgeBackgroundColor({color: [255, 215, 0, 255]}); //goldenrod          
		chrome.browserAction.setBadgeText({text: "..."});           
		//TODO update tooltip text as well      
		//TODO show different icon on failure
		//chrome.browserAction.setBadgeBackgroundColor({color: [220, 20, 60, 255]}); //crimson    
		add(localStorage.username, localStorage.password, url, title, null, function() {
			chrome.browserAction.setBadgeBackgroundColor({color: [0, 205, 0, 255]}); //green 3 
			chrome.browserAction.setBadgeText({text: "OK"}); 
			setTimeout("chrome.browserAction.setBadgeText({text: ''})", 1000) //clear badge after 1 sec
		});  
		
	}
	
	function addFromContextMenu(info, tab) {
		if (info.linkUrl) { 
			//TODO figure out how to fetch title of target instead of just URL
			//TODO check for http or https and error appropriately
			console.debug('right-clicked URL: ' + info.linkUrl);
			addWithBadgeIndicator(info.linkUrl, info.linkUrl);
		}
		else { //right clicked on page
			console.debug('clicked on page: ' + info.pageUrl);
			addWithBadgeIndicator(info.pageUrl, tab.title); 
		}                                                                               
		//TODO deal with frames
	}

	function init(){
		chrome.browserAction.onClicked.addListener(addTab);
		api = new ReadItLaterAPI();
		initContextMenu();
	}
	
	function initContextMenu() {
		chrome.contextMenus.create({
			"title": "Add to Read It Later",
			"contexts": ["page", "link"],
			"onclick": addFromContextMenu
		});
	}                                                                               


	</script>               
</head>

<body onload="init()">
</body>
</html>